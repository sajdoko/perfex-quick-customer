name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create properly named archive
        run: |
          # Create a temporary directory with the module name
          mkdir -p temp_build/quick_customer
          
          # Copy files excluding development files
          rsync -av --progress . temp_build/quick_customer/ \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitattributes' \
            --exclude='.gitignore' \
            --exclude='*.md' \
            --exclude='temp_build' \
            --exclude='package.ps1' \
            --exclude='package.sh' \
          
          # Create ZIP archive with quick_customer folder at root
          cd temp_build
          zip -r ../quick_customer-${GITHUB_REF#refs/tags/}.zip quick_customer/
          
          # Create tar.gz archive with quick_customer folder at root
          tar -czf ../quick_customer-${GITHUB_REF#refs/tags/}.tar.gz quick_customer/
          cd ..
          
          # Cleanup
          rm -rf temp_build

      - name: Extract version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Quick Customer v${{ steps.version.outputs.version }}
          body: |
            ## Quick Customer Module v${{ steps.version.outputs.version }}

            ### Installation Instructions

            1. Download `quick_customer-v${{ steps.version.outputs.version }}.zip` below
            2. Go to Setup → Modules in Perfex CRM
            3. Click on "Upload Module"
            4. Select the downloaded ZIP file and upload it
            5. Find "Quick Customer" and click Activate

            ⚠️ **Important:** The folder must be named exactly `quick_customer` inside the `modules/` directory.

            ### Changelog

            See [CHANGELOG.md](https://github.com/sajdoko/perfex-quick-customer/blob/master/CHANGELOG.md) for full details.

            ### Documentation

            - [Installation Guide](https://github.com/sajdoko/perfex-quick-customer/blob/master/INSTALL.md)
            - [Full README](https://github.com/sajdoko/perfex-quick-customer/blob/master/README.md)
          files: |
            quick_customer-v*.zip
            quick_customer-v*.tar.gz
          draft: false
          prerelease: false
